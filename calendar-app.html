<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/favicon-solar.png" />
  <title>calendar mini app — 451 solarized</title>
  <link rel="stylesheet" href="css/solar-calendar-style.css" />
</head>

<body>
  <!-- Main App -->
  <div class="app" id="mainApp">
    <header>
      <div class="brand" aria-label="アプリ名">
        <div class="logo">✏️</div>
        <h1>学生用カレンダー <span class="hint"><br>課題/試験/授業を一括管理</span></h1>
      </div>
      
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div class="user-info">
          <span id="userEmail"></span>
        </div>
        <div class="sync-status" id="syncStatus">
          <span class="loading-spinner"></span>
          <span>同期中...</span>
        </div>
        <button id="theme-toggle" title="テーマ切替">
          <svg id="moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
          </svg>
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
        </button>
        <button id="logoutBtn" class="danger">Log out</button>
      </div>
      
      <div class="controls">
        <div class="row-nav">
          <button id="prevBtn" title="前の月">◀</button>
          <button id="nextBtn" title="次の月">▶</button>
          <select id="monthSelect" title="月"></select>
          <select id="yearSelect" title="年"></select>
          <button id="todayBtn" class="ghost">今日</button>
        </div>
        <div class="row-action">
          <button id="addBtn" class="primary">＋ 予定を追加</button>
          <button id="exportPdfBtn" class="primary">PDF Export</button>
        </div>
        <div class="row-export">
          <button id="exportBtn" class="ghost">Export</button>
          <label class="ghost" style="
          padding:12px 14px; 
          cursor:pointer; 
          border: #aaaaaa 2px solid;
          border-radius:12px; 
          display:inline-flex; 
          align-items:center; 
          min-height:48px;">
            Import File
            <input type="file" id="importFile" accept="application/json" hidden>
          </label>
        </div>
        <div class="row-danger">
          <button id="clearBtn" class="warn" title="全データ削除">全消去</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="panel-header">
          <div class="legend" id="legend"></div>
          <div class="hint">クリックで日付に予定を追加／予定を編集</div>
        </div>
        <div id="calendar" class="calendar" aria-label="カレンダー"></div>
      </section>

      <aside class="panel">
        <div class="panel-header">
          <strong>ダッシュボード</strong>
          <div class="flex">
            <select id="filterCourse">
              <option value="">すべての科目</option>
            </select>
            <select id="filterType">
              <option value="">すべての種類</option>
              <option>時程変更</option>
              <option>課題提出日</option>
              <option>試験</option>
              <option>定期試験 / 学校模試</option>
              <option>東進模試</option>
              <option>部活動</option>
              <option>長期休み</option>
              <option>その他</option>
            </select>
          </div>
        </div>
        <div class="panel-body">
          <div class="kpi">
            <div class="card">
              <div class="lbl">今月の予定</div>
              <div id="kpiTotal" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">全体の予定</div>
              <div id="kpiAll" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">近日（7日）</div>
              <div id="kpiSoon" class="num">0</div>
            </div>
          </div>
          <h3>近日の締切</h3>
          <div id="upcoming" class="list"></div>
        </div>
      </aside>
    </div>
  </div>

  <dialog id="eventModal">
    <form method="dialog" id="eventForm">
      <div class="modal-head">
        <strong id="modalTitle">予定を追加</strong>
        <div class="flex">
          <button type="button" value="cancel" onclick="eventModal.close()">閉じる</button>
          <button id="deleteBtn" class="danger" type="button" style="display:none">削除</button>
          <button id="saveBtn" class="primary" type="submit">保存</button>
        </div>
      </div>
      <div class="modal-body">
        <input type="hidden" id="eventId">
        <input type="hidden" id="groupId">
        
        <div id="groupWarning" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px;"></div>
        
        <div class="row">
          <label>タイトル
            <input id="title" required placeholder="例: 英語課題 Unit5 提出">
          </label>
          <label id="courseLabel">科目（自由入力）
            <input id="course" list="courseList" placeholder="例: 英語">
            <datalist id="courseList"></datalist>
          </label>
        </div>
        <div class="row">
          <label>日付
            <input id="date" type="date" required>
          </label>
          <label>
            <input type="checkbox" id="multiDate" style="width:auto; margin-right:8px">
            複数日に登録
          </label>
        </div>
        <div class="row">
          <label>開始時刻（任意）
            <input id="start" type="time" placeholder="例: 09:00">
          </label>
          <label>終了時刻（任意）
            <input id="end" type="time" placeholder="例: 17:00">
          </label>
        </div>
        <div class="row" id="endDateRow" style="display:none">
          <label>終了日（複数日登録時）
            <input id="endDate" type="date">
          </label>
        </div>
        <div class="row">
          <label>種類
            <select id="type">
              <option>時程変更</option>
              <option>課題提出日</option>
              <option>試験</option>
              <option>定期試験 / 学校模試</option>
              <option>東進模試</option>
              <option>部活動</option>
              <option>長期休み</option>
              <option>その他</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>メモ
            <textarea id="notes" rows="3" placeholder="必要な持ち物／提出方法など"></textarea>
          </label>
        </div>
        <div class="hint" id="multiDateHint" style="display:none; color:var(--brand); font-weight:600">
          ✓ 複数日に同じ予定を登録します（開始日〜終了日の各日に個別の予定として作成）
        </div>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // =====================================
    // Supabase Configuration
    // =====================================
    const SUPABASE_URL = 'https://abfuanjincelcyrlswsp.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiZnVhbmppbmNlbGN5cmxzd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjE4MDIsImV4cCI6MjA4MzQzNzgwMn0.OD7371E7A1ZRiqF6SGXnp2JSzPowg2zTt-V36GQ7x9A'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // =====================================
    // State Management
    // =====================================
    const state = {
      user: null,
      events: [],
      year: new Date().getFullYear(),
      month: new Date().getMonth(),
      filterCourse: '',
      filterType: ''
    }

    // =====================================
    // Utility Functions
    // =====================================
    const $ = (sel, el = document) => el.querySelector(sel)
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel))

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36)

    const colorFromCourse = (name) => {
      if (!name) return '#64748b'
      let h = 0
      for (let i = 0; i < name.length; i++) {
        h = (h * 31 + name.charCodeAt(i)) % 360
      }
      return `hsl(${h}, 70%, 50%)`
    }

    const colorFromType = (type) => {
      const typeColors = {
        '時程変更': '#8a9990',
        '試験': '#e63946',
        '定期試験 / 学校模試': '#f7a500',
        '東進模試': '#009c88',
        '部活動': '#00c3ff',
        '長期休み': '#ff6b9d'
      }
      return typeColors[type] || null
    }

    function formatDate(d) {
      const dt = d instanceof Date ? d : new Date(d)
      return dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0')
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]))
    }

    // =====================================
    // Theme Management
    // =====================================
    const themeToggle = $('#theme-toggle')
    const savedTheme = localStorage.getItem('theme')
    if (savedTheme === 'dark') {
      document.body.classList.add('dark')
    }

    themeToggle.onclick = () => {
      document.body.classList.toggle('dark')
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light')
    }

    const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
    const monthSelect = $('#monthSelect')
    const yearSelect = $('#yearSelect')

    // =====================================
    // Sync Status Management
    // =====================================
    function updateSyncStatus(status) {
      const syncStatus = $('#syncStatus')
      syncStatus.className = 'sync-status'
      
      if (status === 'synced') {
        syncStatus.classList.add('synced')
        syncStatus.innerHTML = '<span>✓</span><span>同期済み</span>'
      } else if (status === 'syncing') {
        syncStatus.classList.add('syncing')
        syncStatus.innerHTML = '<span class="loading-spinner"></span><span>同期中...</span>'
      } else if (status === 'error') {
        syncStatus.classList.add('error')
        syncStatus.innerHTML = '<span>⚠</span><span>同期エラー</span>'
      }
    }

    // =====================================
    // Supabase Event Management
    // =====================================
    // Check initial session and load events
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) {
      window.location.replace('index.html')
    } else {
      state.user = session.user
      $('#userEmail').textContent = session.user.email
      mainApp.style.display = 'block'
      await loadEvents()
      setTimeout(() => render(), 100)
    }

    supabase.auth.onAuthStateChange((event, session) => {
      if (!session) {
        window.location.replace('index.html')
      }
    })

    logoutBtn.onclick = async () => {
      if (confirm('ログアウトしますか？')) {
        await supabase.auth.signOut()
        window.location.replace('index.html')
      }
    }

    async function loadEvents() {
      try {
        updateSyncStatus('syncing')
        const { data, error } = await supabase
          .from('calendar_app')
          .select('*')
          .eq('user_id', state.user.id)
          .order('date', { ascending: true })

        if (error) throw error

        state.events = data || []
        render()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error loading events:', error)
        updateSyncStatus('error')
      }
    }

    async function saveEvent(event) {
      try {
        updateSyncStatus('syncing')
        const eventData = {
          ...event,
          user_id: state.user.id
        }

        const { data, error } = await supabase
          .from('calendar_app')
          .upsert(eventData)
          .select()

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
        return data
      } catch (error) {
        console.error('Error saving event:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function deleteEvent(id) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('calendar_app')
          .delete()
          .eq('id', id)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error deleting event:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function deleteEventGroup(groupId) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('calendar_app')
          .delete()
          .eq('group_id', groupId)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error deleting event group:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function updateEventGroup(groupId, updates) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('calendar_app')
          .update(updates)
          .eq('group_id', groupId)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error updating event group:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function clearAllEvents() {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('calendar_app')
          .delete()
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error clearing events:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    supabase
      .channel('events')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'calendar_app' }, (payload) => {
        if (state.user && payload.new?.user_id === state.user.id) {
          loadEvents()
        }
      })
      .subscribe()

    // =====================================
    // Calendar Rendering
    // =====================================


    for (let m = 0; m < 12; m++) {
      const opt = document.createElement('option')
      opt.value = m
      opt.textContent = monthNames[m]
      monthSelect.appendChild(opt)
    }

    const thisYear = new Date().getFullYear()
    for (let y = thisYear - 3; y <= thisYear + 3; y++) {
      const opt = document.createElement('option')
      opt.value = y
      opt.textContent = y + '年'
      yearSelect.appendChild(opt)
    }

    function render() {
      if (!monthSelect || !yearSelect) {
        return
      }
      
      monthSelect.value = state.month
      yearSelect.value = state.year
      renderLegend()
      renderCalendar()
      renderDashboard()
      fillCourseDatalist()
    }

    function getMonthMatrix(y, m) {
      const days = []
      const firstDay = new Date(y, m, 1)
      let dayOfWeek = firstDay.getDay()
      dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1
      
      for (let i = 0; i < dayOfWeek; i++) {
        days.push(null)
      }
      
      const last = new Date(y, m + 1, 0).getDate()
      for (let d = 1; d <= last; d++) {
        days.push(new Date(y, m, d))
      }
      return days
    }

    function renderCalendar() {
      const cal = $('#calendar')
      cal.innerHTML = ''
      const dows = ['月', '火', '水', '木', '金', '土', '日']
      dows.forEach(d => {
        const h = document.createElement('div')
        h.className = 'dow'
        h.textContent = d
        cal.appendChild(h)
      })

      const cells = getMonthMatrix(state.year, state.month)
      const todayStr = formatDate(new Date())

      const filtered = state.events.filter(e =>
        (!state.filterCourse || e.course === state.filterCourse) &&
        (!state.filterType || e.type === state.filterType)
      )

      const counts = {}
      filtered.forEach(e => {
        counts[e.date] = (counts[e.date] || 0) + 1
      })

      cells.forEach(d => {
        const cell = document.createElement('div')
        
        if (d === null) {
          cell.className = 'cell'
          cell.style.background = 'transparent'
          cell.style.pointerEvents = 'none'
          cal.appendChild(cell)
          return
        }
        
        const dStr = formatDate(d)
        const inMonth = d.getMonth() === state.month
        cell.className = 'cell heat-' + Math.min(4, counts[dStr] || 0)
        if (!inMonth) cell.style.opacity = 0.35
        if (dStr === todayStr) cell.classList.add('today')

        const dateEl = document.createElement('div')
        dateEl.className = 'date'
        dateEl.textContent = `${d.getDate()}`
        cell.appendChild(dateEl)

        filtered
          .filter(e => e.date === dStr && inMonth)
          .sort((a, b) => a.title.localeCompare(b.title))
          .slice(0, 4)
          .forEach(e => {
            const chip = document.createElement('div')
            chip.className = 'chip'
            const timeStr = e.start ? ` ${e.start}` : ''
            chip.title = `${e.title}（${e.course || '科目未設定'}）${timeStr}`
            const typeColor = colorFromType(e.type)
            chip.style.background = typeColor || colorFromCourse(e.course)
            chip.style.color = '#fff'
            chip.textContent = `${timeStr ? timeStr + ' ' : ''}${e.title || '無題'}`
            chip.onclick = () => openModal(e)
            cell.appendChild(chip)
          })

        cell.onclick = ev => {
          if (ev.target === cell || ev.target === dateEl) openModal({ date: dStr })
        }

        cal.appendChild(cell)
      })
    }

    function renderLegend() {
      const box = $('#legend')
      box.innerHTML = ''
      const courses = [...new Set(state.events.map(e => e.course).filter(Boolean))].sort()
      const fc = $('#filterCourse')
      fc.innerHTML = '<option value="">すべての科目</option>' + courses.map(c => `<option>${c}</option>`).join('')
      courses.forEach(c => {
        const el = document.createElement('span')
        el.className = 'chip'
        el.textContent = c
        el.style.background = colorFromCourse(c)
        el.style.color = '#fff'
        el.onclick = () => {
          state.filterCourse = state.filterCourse === c ? '' : c
          $('#filterCourse').value = state.filterCourse
          render()
        }
        box.appendChild(el)
      })
    }

    function renderDashboard() {
      const now = new Date()
      const monthStart = new Date(state.year, state.month, 1)
      const monthEnd = new Date(state.year, state.month + 1, 0)

      const filtered = state.events.filter(e =>
        (!state.filterCourse || e.course === state.filterCourse) &&
        (!state.filterType || e.type === state.filterType)
      )
      const inMonth = filtered.filter(e => {
        const d = new Date(e.date)
        return d >= monthStart && d <= monthEnd
      })

      $('#kpiTotal').textContent = inMonth.length
      $('#kpiAll').textContent = filtered.length
      $('#kpiSoon').textContent = filtered.filter(e => {
        const d = new Date(e.date)
        const diff = (d - now) / (1000 * 60 * 60 * 24)
        return diff >= 0 && diff <= 7
      }).length

      const upcoming = filtered
        .filter(e => new Date(e.date) >= new Date(now.getFullYear(), now.getMonth(), now.getDate()))
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 20)

      const box = $('#upcoming')
      box.innerHTML = ''
      if (upcoming.length === 0) {
        box.innerHTML = '<div class="hint">直近の予定はありません。</div>'
        return
      }
      upcoming.forEach(e => {
        const it = document.createElement('div')
        it.className = 'item'
        const left = document.createElement('div')
        const timeStr = e.start ? ` ${e.start}${e.end ? '-' + e.end : ''}` : ''
        left.innerHTML = `<div><strong>${escapeHtml(e.title || '無題')}</strong></div>
          <div class="meta">${e.date}${timeStr} ／ ${e.course || '科目未設定'} ／ ${e.type}</div>
          ${e.notes ? `<div class="hint">${escapeHtml(e.notes)}</div>` : ''}`
        const right = document.createElement('div')
        right.style.display = 'flex'
        right.style.flexDirection = 'column'
        right.style.gap = '6px'
        right.style.alignItems = 'end'
        const edit = document.createElement('button')
        edit.textContent = '編集'
        edit.onclick = () => openModal(e)
        right.appendChild(edit)
        it.appendChild(left)
        it.appendChild(right)
        box.appendChild(it)
      })
    }

    function fillCourseDatalist() {
      const list = $('#courseList')
      list.innerHTML = ''
      ;[...new Set(state.events.map(e => e.course).filter(Boolean))].sort().forEach(c => {
        const opt = document.createElement('option')
        opt.value = c
        list.appendChild(opt)
      })
    }

    // =====================================
    // Event Modal
    // =====================================
    const eventModal = $('#eventModal')

    function updateCourseVisibility() {
      const type = $('#type').value
      const courseLabel = $('#courseLabel')
      const courseInput = $('#course')
      const noCourseTypes = ['時程変更', '試験', '定期試験 / 学校模試', '東進模試', '部活動', '長期休み']

      if (noCourseTypes.includes(type)) {
        courseInput.disabled = true
        courseInput.style.background = '#e2e8f0'
        courseInput.style.color = '#94a3b8'
        courseLabel.style.opacity = '0.5'
      } else {
        courseInput.disabled = false
        courseInput.style.background = 'var(--panel)'
        courseInput.style.color = 'var(--text)'
        courseLabel.style.opacity = '1'
      }
    }

    function toggleMultiDate() {
      const isMulti = $('#multiDate').checked
      $('#endDateRow').style.display = isMulti ? '' : 'none'
      $('#multiDateHint').style.display = isMulti ? 'block' : 'none'
      if (isMulti) {
        $('#endDate').required = true
      } else {
        $('#endDate').required = false
      }
    }

    function openModal(e = {}) {
      const isGrouped = e.group_id && state.events.filter(ev => ev.group_id === e.group_id).length > 1
      
      $('#modalTitle').textContent = e.id ? '予定を編集' : '予定を追加'
      $('#eventId').value = e.id || ''
      $('#groupId').value = e.group_id || ''
      $('#title').value = e.title || ''
      $('#course').value = e.course || ''
      $('#date').value = e.date || formatDate(new Date(state.year, state.month, 1))
      $('#endDate').value = ''
      $('#multiDate').checked = false
      $('#type').value = e.type || '課題提出日'
      $('#notes').value = e.notes || ''
      
      if (isGrouped) {
        $('#groupWarning').style.display = 'block'
        const groupEvents = state.events.filter(ev => ev.group_id === e.group_id)
        const dates = groupEvents.map(ev => ev.date).sort()
        $('#groupWarning').innerHTML = `⚠️ この予定は${dates[0]}〜${dates[dates.length-1]}の${groupEvents.length}日間のグループ予定です。編集すると全ての日付に反映されます。`
      } else {
        $('#groupWarning').style.display = 'none'
      }
      
      updateCourseVisibility()
      toggleMultiDate()
      $('#deleteBtn').style.display = e.id ? '' : 'none'
      eventModal.showModal()
      setTimeout(() => $('#title').focus(), 50)
    }

    $('#type').addEventListener('change', updateCourseVisibility)
    $('#multiDate').addEventListener('change', toggleMultiDate)

    $('#eventForm').addEventListener('submit', async (ev) => {
      ev.preventDefault()
      const id = $('#eventId').value || uid()
      const groupId = $('#groupId').value
      const isMulti = $('#multiDate').checked
      const startDate = $('#date').value
      const endDate = $('#endDate').value

      const evObj = {
        title: $('#title').value.trim() || '無題',
        course: $('#course').value.trim(),
        type: $('#type').value,
        notes: $('#notes').value.trim()
      }

      try {
        if (isMulti && endDate && endDate >= startDate) {
          const start = new Date(startDate)
          const end = new Date(endDate)
          const newGroupId = uid()

          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = formatDate(d)
            const newId = uid()
            await saveEvent({
              ...evObj,
              id: newId,
              group_id: newGroupId,
              date: dateStr
            })
          }
        } else if (groupId && state.events.filter(e => e.group_id === groupId).length > 1) {
          await updateEventGroup(groupId, evObj)
        } else {
          await saveEvent({
            ...evObj,
            id,
            group_id: groupId || null,
            date: startDate
          })
        }

        eventModal.close()
        render()
      } catch (error) {
        alert('保存に失敗しました: ' + error.message)
      }
    })

    $('#deleteBtn').onclick = async () => {
      const id = $('#eventId').value
      const groupId = $('#groupId').value
      if (!id) return
      
      const isGrouped = groupId && state.events.filter(e => e.group_id === groupId).length > 1
      
      if (isGrouped) {
        const groupEvents = state.events.filter(e => e.group_id === groupId)
        if (confirm(`この予定は${groupEvents.length}日間のグループ予定です。全ての日付を削除しますか？\n\n個別の日だけ削除したい場合は「キャンセル」を押してください。`)) {
          try {
            await deleteEventGroup(groupId)
            eventModal.close()
            render()
          } catch (error) {
            alert('削除に失敗しました: ' + error.message)
          }
        } else {
          if (confirm('この日だけ削除しますか？')) {
            try {
              await deleteEvent(id)
              eventModal.close()
              render()
            } catch (error) {
              alert('削除に失敗しました: ' + error.message)
            }
          }
        }
      } else {
        if (confirm('この予定を削除しますか？')) {
          try {
            await deleteEvent(id)
            eventModal.close()
            render()
          } catch (error) {
            alert('削除に失敗しました: ' + error.message)
          }
        }
      }
    }

    // =====================================
    // Navigation Controls
    // =====================================
    $('#prevBtn').onclick = () => {
      const d = new Date(state.year, state.month - 1, 1)
      state.year = d.getFullYear()
      state.month = d.getMonth()
      render()
    }

    $('#nextBtn').onclick = () => {
      const d = new Date(state.year, state.month + 1, 1)
      state.year = d.getFullYear()
      state.month = d.getMonth()
      render()
    }

    $('#todayBtn').onclick = () => {
      const now = new Date()
      state.year = now.getFullYear()
      state.month = now.getMonth()
      state.filterCourse = ''
      state.filterType = ''
      render()
    }

    monthSelect.onchange = () => {
      state.month = Number(monthSelect.value)
      render()
    }

    yearSelect.onchange = () => {
      state.year = Number(yearSelect.value)
      render()
    }

    $('#filterCourse').onchange = e => {
      state.filterCourse = e.target.value
      render()
    }

    $('#filterType').onchange = e => {
      state.filterType = e.target.value
      render()
    }

    $('#addBtn').onclick = () => openModal({ date: formatDate(new Date(state.year, state.month, 1)) })

    // =====================================
    // Export/Import/Clear
    // =====================================
    $('#exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(state.events, null, 2)], { type: 'application/json' })
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'student-calendar-data.json'
      a.click()
      URL.revokeObjectURL(a.href)
    }

    $('#importFile').onchange = async e => {
      const file = e.target.files[0]
      if (!file) return
      try {
        const text = await file.text()
        const data = JSON.parse(text)
        if (!Array.isArray(data)) throw new Error('JSON形式が不正です')

        for (const ev of data) {
          if (!ev.id) ev.id = uid()
          await saveEvent(ev)
        }

        alert('インポートしました。')
      } catch (err) {
        alert('インポートに失敗: ' + err.message)
      }
      e.target.value = ''
    }

    $('#clearBtn').onclick = async () => {
      if (confirm('本当に全データを削除しますか？この操作は取り消せません。')) {
        try {
          await clearAllEvents()
        } catch (error) {
          alert('削除に失敗しました: ' + error.message)
        }
      }
    }

    // =====================================
    // PDF Export - Final Fix (Ink-Saving White Background)
    // =====================================
    $('#exportPdfBtn').onclick = async () => {
      const wasDark = document.body.classList.contains('dark')
      
      try {
        // Force light mode
        if (wasDark) {
          document.body.classList.remove('dark')
        }
        
        await new Promise(resolve => setTimeout(resolve, 300))
        
        const panel = document.querySelector('.panel')
        
        // 一時的に背景を完全な白に変更（インク節約）
        const originalPanelBg = panel.style.backgroundColor
        const originalBodyBg = document.body.style.backgroundColor
        const cells = document.querySelectorAll('.cell')
        const originalCellBgs = Array.from(cells).map(c => c.style.backgroundColor)
        
        panel.style.backgroundColor = '#ffffff'
        document.body.style.backgroundColor = '#ffffff'
        cells.forEach(cell => {
          // heat クラスの背景色を削除して白に
          if (cell.className.includes('heat-')) {
            cell.style.backgroundColor = '#ffffff'
          }
        })
        
        const opt = {
          margin: 10,
          filename: `カレンダー_${state.year}_${state.month + 1}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 1.8,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'landscape'
          }
        }
        
        await html2pdf().set(opt).from(panel).save()
        
        // 背景色を元に戻す
        panel.style.backgroundColor = originalPanelBg
        document.body.style.backgroundColor = originalBodyBg
        cells.forEach((cell, i) => {
          cell.style.backgroundColor = originalCellBgs[i]
        })
        
      } catch (error) {
        console.error('PDF export failed:', error)
        alert('PDF出力に失敗しました: ' + error.message)
      } finally {
        if (wasDark) {
          document.body.classList.add('dark')
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>