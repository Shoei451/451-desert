<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/favicon-solar.png" />
  <title>Ideas Manager â€” 451-Solarized</title>
  <link rel="stylesheet" href="css/solar-ideas-style.css" />
</head>

<body>
  <!-- Main App -->
  <div class="app" id="mainApp">
    <header>
      <div class="brand" aria-label="ã‚¢ãƒ—ãƒªå">
        <div class="logo">ğŸ’¡</div>
        <h1>Ideas Manager <span class="hint"><br>ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¨˜éŒ²ãƒ»æ•´ç†ãƒ»ç™ºå±•ã•ã›ã‚‹</span></h1>
      </div>
      
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div class="user-info">
          <span id="userEmail"></span>
        </div>
        <div class="sync-status" id="syncStatus">
          <span class="loading-spinner"></span>
          <span>åŒæœŸä¸­...</span>
        </div>
        <button id="theme-toggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
          <svg id="moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
          </svg>
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
        </button>
        <button id="logoutBtn" class="danger">Log out</button>
      </div>
      
      <div class="controls">
        <div class="row-action">
          <button id="addBtn" class="primary">ï¼‹ æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢</button>
        </div>
        <div class="row-filter">
          <select id="sortBy">
            <option value="modified">æ›´æ–°æ—¥æ™‚é †</option>
            <option value="created">ä½œæˆæ—¥æ™‚é †</option>
            <option value="name">åå‰é †</option>
          </select>
          <select id="filterTag">
            <option value="">ã™ã¹ã¦ã®ã‚¿ã‚°</option>
          </select>
        </div>
        <div class="row-export">
          <button id="exportBtn" class="ghost">Export JSON</button>
          <label class="ghost" style="
          padding:12px 14px; 
          cursor:pointer; 
          border: #aaaaaa 2px solid;
          border-radius:12px; 
          display:inline-flex; 
          align-items:center; 
          min-height:48px;">
            Import JSON
            <input type="file" id="importFile" accept="application/json" hidden>
          </label>
        </div>
        <div class="row-danger">
          <button id="clearBtn" class="warn" title="å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤">å…¨æ¶ˆå»</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="panel main-panel">
        <div class="panel-header">
          <strong>ã‚¢ã‚¤ãƒ‡ã‚¢ä¸€è¦§</strong>
          <div class="hint">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›† / ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ</div>
        </div>
        <div class="panel-body" id="ideasList">
          <!-- Ideas will be rendered here -->
        </div>
      </section>

      <aside class="panel">
        <div class="panel-header">
          <strong>çµ±è¨ˆ</strong>
        </div>
        <div class="panel-body">
          <div class="kpi">
            <div class="card">
              <div class="lbl">ç·ã‚¢ã‚¤ãƒ‡ã‚¢æ•°</div>
              <div id="kpiTotal" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">ã‚¿ã‚°æ•°</div>
              <div id="kpiTags" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">ä»Šé€±ã®æ–°è¦</div>
              <div id="kpiWeek" class="num">0</div>
            </div>
          </div>
          
          <h3>ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰</h3>
          <div id="tagCloud" class="tag-cloud"></div>
          
          <h3>æœ€è¿‘ã®æ›´æ–°</h3>
          <div id="recentList" class="list"></div>
        </div>
      </aside>
    </div>
  </div>

  <dialog id="ideaModal">
    <form method="dialog" id="ideaForm">
      <div class="modal-head">
        <strong id="modalTitle">æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢</strong>
        <div class="flex">
          <button type="button" value="cancel" onclick="ideaModal.close()">é–‰ã˜ã‚‹</button>
          <button id="deleteBtn" class="danger" type="button" style="display:none">å‰Šé™¤</button>
          <button id="saveBtn" class="primary" type="submit">ä¿å­˜</button>
        </div>
      </div>
      <div class="modal-body">
        <input type="hidden" id="ideaId">
        
        <div class="row full">
          <label>ã‚¢ã‚¤ãƒ‡ã‚¢å
            <input id="ideaName" required placeholder="ä¾‹: æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ" autofocus>
          </label>
        </div>
        
        <div class="row full">
          <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            <input id="ideaTags" placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ, å­¦æ ¡, ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°">
            <div class="hint">è¤‡æ•°ã®ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã§ãã¾ã™</div>
          </label>
        </div>
        
        <div class="row full">
          <label>è©³ç´°ãƒ¡ãƒ¢
            <textarea id="ideaContent" rows="10" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ã®è©³ç´°ã‚’è‡ªç”±ã«è¨˜éŒ²..."></textarea>
          </label>
        </div>
        
        <div class="metadata">
          <div class="meta-item">
            <span class="meta-label">ä½œæˆæ—¥æ™‚:</span>
            <span id="createdDisplay">-</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">æœ€çµ‚æ›´æ–°:</span>
            <span id="modifiedDisplay">-</span>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // =====================================
    // Supabase Configuration
    // =====================================
    const SUPABASE_URL = 'https://abfuanjincelcyrlswsp.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiZnVhbmppbmNlbGN5cmxzd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjE4MDIsImV4cCI6MjA4MzQzNzgwMn0.OD7371E7A1ZRiqF6SGXnp2JSzPowg2zTt-V36GQ7x9A'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // =====================================
    // State Management
    // =====================================
    const state = {
      user: null,
      ideas: [],
      sortBy: 'modified',
      filterTag: ''
    }

    // =====================================
    // Utility Functions
    // =====================================
    const $ = (sel, el = document) => el.querySelector(sel)
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel))

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36)

    function formatDateTime(dateString) {
      const date = new Date(dateString)
      const now = new Date()
      const diffMs = now - date
      const diffMins = Math.floor(diffMs / 60000)
      const diffHours = Math.floor(diffMs / 3600000)
      const diffDays = Math.floor(diffMs / 86400000)

      if (diffMins < 1) return 'ãŸã£ãŸä»Š'
      if (diffMins < 60) return `${diffMins}åˆ†å‰`
      if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`
      if (diffDays < 7) return `${diffDays}æ—¥å‰`
      
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]))
    }

    function parseTags(tagString) {
      if (!tagString) return []
      return tagString
        .split(',')
        .map(t => t.trim())
        .filter(t => t.length > 0)
    }

    function colorFromTag(tag) {
      let h = 0
      for (let i = 0; i < tag.length; i++) {
        h = (h * 31 + tag.charCodeAt(i)) % 360
      }
      return `hsl(${h}, 70%, 50%)`
    }

    // =====================================
    // Theme Management
    // =====================================
    const themeToggle = $('#theme-toggle')
    const savedTheme = localStorage.getItem('theme')
    if (savedTheme === 'dark') {
      document.body.classList.add('dark')
    }

    themeToggle.onclick = () => {
      document.body.classList.toggle('dark')
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light')
    }

    // =====================================
    // Sync Status Management
    // =====================================
    function updateSyncStatus(status) {
      const syncStatus = $('#syncStatus')
      syncStatus.className = 'sync-status'
      
      if (status === 'synced') {
        syncStatus.classList.add('synced')
        syncStatus.innerHTML = '<span>âœ“</span><span>åŒæœŸæ¸ˆã¿</span>'
      } else if (status === 'syncing') {
        syncStatus.classList.add('syncing')
        syncStatus.innerHTML = '<span class="loading-spinner"></span><span>åŒæœŸä¸­...</span>'
      } else if (status === 'error') {
        syncStatus.classList.add('error')
        syncStatus.innerHTML = '<span>âš </span><span>åŒæœŸã‚¨ãƒ©ãƒ¼</span>'
      }
    }

    // =====================================
    // Supabase Event Management
    // =====================================
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) {
      window.location.replace('index.html')
    } else {
      state.user = session.user
      $('#userEmail').textContent = session.user.email
      mainApp.style.display = 'block'
      await loadIdeas()
      render()
    }

    supabase.auth.onAuthStateChange((event, session) => {
      if (!session) {
        window.location.replace('index.html')
      }
    })

    logoutBtn.onclick = async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        await supabase.auth.signOut()
        window.location.replace('index.html')
      }
    }

    async function loadIdeas() {
      try {
        updateSyncStatus('syncing')
        const { data, error } = await supabase
          .from('ideas_app')
          .select('*')
          .eq('user_id', state.user.id)
          .order('modified_at', { ascending: false })

        if (error) throw error

        state.ideas = data || []
        render()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error loading ideas:', error)
        updateSyncStatus('error')
      }
    }

    async function saveIdea(idea) {
      try {
        updateSyncStatus('syncing')
        const ideaData = {
          ...idea,
          user_id: state.user.id,
          modified_at: new Date().toISOString()
        }

        const { data, error } = await supabase
          .from('ideas_app')
          .upsert(ideaData)
          .select()

        if (error) throw error

        await loadIdeas()
        updateSyncStatus('synced')
        return data
      } catch (error) {
        console.error('Error saving idea:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function deleteIdea(id) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('ideas_app')
          .delete()
          .eq('id', id)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadIdeas()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error deleting idea:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function clearAllIdeas() {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('ideas_app')
          .delete()
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadIdeas()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error clearing ideas:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    supabase
      .channel('ideas')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'ideas_app' }, (payload) => {
        if (state.user && payload.new?.user_id === state.user.id) {
          loadIdeas()
        }
      })
      .subscribe()

    // =====================================
    // Rendering
    // =====================================
    function render() {
      renderIdeasList()
      renderStats()
      renderTagCloud()
      renderRecent()
      fillTagFilter()
    }

    function getSortedFilteredIdeas() {
      let ideas = [...state.ideas]
      
      // Filter by tag
      if (state.filterTag) {
        ideas = ideas.filter(idea => {
          const tags = parseTags(idea.tags)
          return tags.includes(state.filterTag)
        })
      }
      
      // Sort
      if (state.sortBy === 'modified') {
        ideas.sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at))
      } else if (state.sortBy === 'created') {
        ideas.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      } else if (state.sortBy === 'name') {
        ideas.sort((a, b) => a.name.localeCompare(b.name))
      }
      
      return ideas
    }

    function renderIdeasList() {
      const list = $('#ideasList')
      const ideas = getSortedFilteredIdeas()
      
      if (ideas.length === 0) {
        list.innerHTML = '<div class="empty-state">ã¾ã ã‚¢ã‚¤ãƒ‡ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œï¼‹ æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>'
        return
      }
      
      list.innerHTML = ''
      ideas.forEach(idea => {
        const card = document.createElement('div')
        card.className = 'idea-card'
        
        const tags = parseTags(idea.tags)
        const tagsHtml = tags.map(tag => 
          `<span class="tag" style="background: ${colorFromTag(tag)}">${escapeHtml(tag)}</span>`
        ).join('')
        
        const preview = idea.content 
          ? escapeHtml(idea.content).substring(0, 100) + (idea.content.length > 100 ? '...' : '')
          : ''
        
        card.innerHTML = `
          <div class="idea-header">
            <div class="idea-title">${escapeHtml(idea.name)}</div>
            <div class="idea-meta">${formatDateTime(idea.modified_at)}</div>
          </div>
          ${tagsHtml ? `<div class="idea-tags">${tagsHtml}</div>` : ''}
          ${preview ? `<div class="idea-preview">${preview}</div>` : ''}
        `
        
        card.onclick = () => openModal(idea)
        list.appendChild(card)
      })
    }

    function renderStats() {
      const allIdeas = state.ideas
      const allTags = new Set()
      allIdeas.forEach(idea => {
        parseTags(idea.tags).forEach(tag => allTags.add(tag))
      })
      
      const weekAgo = new Date()
      weekAgo.setDate(weekAgo.getDate() - 7)
      const weekNew = allIdeas.filter(idea => new Date(idea.created_at) >= weekAgo)
      
      $('#kpiTotal').textContent = allIdeas.length
      $('#kpiTags').textContent = allTags.size
      $('#kpiWeek').textContent = weekNew.length
    }

    function renderTagCloud() {
      const tagCounts = {}
      state.ideas.forEach(idea => {
        parseTags(idea.tags).forEach(tag => {
          tagCounts[tag] = (tagCounts[tag] || 0) + 1
        })
      })
      
      const cloud = $('#tagCloud')
      const tags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1])
      
      if (tags.length === 0) {
        cloud.innerHTML = '<div class="hint">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>'
        return
      }
      
      cloud.innerHTML = ''
      tags.forEach(([tag, count]) => {
        const chip = document.createElement('span')
        chip.className = 'tag-chip'
        chip.textContent = `${tag} (${count})`
        chip.style.background = colorFromTag(tag)
        chip.onclick = () => {
          state.filterTag = state.filterTag === tag ? '' : tag
          $('#filterTag').value = state.filterTag
          render()
        }
        cloud.appendChild(chip)
      })
    }

    function renderRecent() {
      const recent = [...state.ideas]
        .sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at))
        .slice(0, 5)
      
      const list = $('#recentList')
      
      if (recent.length === 0) {
        list.innerHTML = '<div class="hint">ã¾ã ã‚¢ã‚¤ãƒ‡ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“</div>'
        return
      }
      
      list.innerHTML = ''
      recent.forEach(idea => {
        const item = document.createElement('div')
        item.className = 'item'
        item.innerHTML = `
          <div>
            <div><strong>${escapeHtml(idea.name)}</strong></div>
            <div class="meta">${formatDateTime(idea.modified_at)}</div>
          </div>
        `
        item.onclick = () => openModal(idea)
        list.appendChild(item)
      })
    }

    function fillTagFilter() {
      const allTags = new Set()
      state.ideas.forEach(idea => {
        parseTags(idea.tags).forEach(tag => allTags.add(tag))
      })
      
      const filter = $('#filterTag')
      filter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚¿ã‚°</option>' + 
        [...allTags].sort().map(tag => `<option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>`).join('')
      filter.value = state.filterTag
    }

    // =====================================
    // Modal
    // =====================================
    const ideaModal = $('#ideaModal')

    function openModal(idea = {}) {
      $('#modalTitle').textContent = idea.id ? 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç·¨é›†' : 'æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢'
      $('#ideaId').value = idea.id || ''
      $('#ideaName').value = idea.name || ''
      $('#ideaTags').value = idea.tags || ''
      $('#ideaContent').value = idea.content || ''
      
      $('#createdDisplay').textContent = idea.created_at 
        ? formatDateTime(idea.created_at) 
        : '-'
      $('#modifiedDisplay').textContent = idea.modified_at 
        ? formatDateTime(idea.modified_at) 
        : '-'
      
      $('#deleteBtn').style.display = idea.id ? '' : 'none'
      ideaModal.showModal()
      setTimeout(() => $('#ideaName').focus(), 50)
    }

    $('#ideaForm').addEventListener('submit', async (ev) => {
      ev.preventDefault()
      const id = $('#ideaId').value || uid()
      const now = new Date().toISOString()
      
      const ideaObj = {
        id,
        name: $('#ideaName').value.trim() || 'ç„¡é¡Œ',
        tags: $('#ideaTags').value.trim(),
        content: $('#ideaContent').value.trim(),
        created_at: $('#ideaId').value ? undefined : now,
        modified_at: now
      }

      try {
        await saveIdea(ideaObj)
        ideaModal.close()
      } catch (error) {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    })

    $('#deleteBtn').onclick = async () => {
      const id = $('#ideaId').value
      if (!id) return
      
      if (confirm('ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        try {
          await deleteIdea(id)
          ideaModal.close()
        } catch (error) {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
        }
      }
    }

    // =====================================
    // Controls
    // =====================================
    $('#addBtn').onclick = () => openModal()

    $('#sortBy').onchange = (e) => {
      state.sortBy = e.target.value
      render()
    }

    $('#filterTag').onchange = (e) => {
      state.filterTag = e.target.value
      render()
    }

    $('#exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(state.ideas, null, 2)], { type: 'application/json' })
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'ideas-export.json'
      a.click()
      URL.revokeObjectURL(a.href)
    }

    $('#importFile').onchange = async e => {
      const file = e.target.files[0]
      if (!file) return
      try {
        const text = await file.text()
        const data = JSON.parse(text)
        if (!Array.isArray(data)) throw new Error('JSONå½¢å¼ãŒä¸æ­£ã§ã™')

        for (const idea of data) {
          if (!idea.id) idea.id = uid()
          if (!idea.created_at) idea.created_at = new Date().toISOString()
          idea.modified_at = new Date().toISOString()
          await saveIdea(idea)
        }

        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚')
      } catch (err) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: ' + err.message)
      }
      e.target.value = ''
    }

    $('#clearBtn').onclick = async () => {
      if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        try {
          await clearAllIdeas()
        } catch (error) {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
        }
      }
    }
  </script>
</body>
</html>