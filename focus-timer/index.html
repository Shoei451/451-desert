<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../images/favicon-solar.png" />
  <title>Focus Timer â€” 451-Solarized</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/solar-focus-style.css" />
</head>

<body>
  <div class="app" id="mainApp">
    <!-- Header with auth controls -->
    <header class="app-header">
      <div class="header-left">
        <div class="logo">â±ï¸</div>
        <h1 class="app-title">Focus</h1>
      </div>
      
      <div class="header-right">
        <div class="user-info">
          <span id="userEmail"></span>
        </div>
        <div class="sync-status" id="syncStatus">
          <span class="loading-spinner"></span>
          <span>åŒæœŸä¸­...</span>
        </div>
        <button id="theme-toggle" title="Toggle Theme">
          <svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        <button id="logoutBtn" class="btn-secondary">Log out</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="timer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span>Timer</span>
      </button>
      <button class="tab-btn" data-tab="analysis">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        <span>Analysis</span>
      </button>
      <button class="tab-btn" data-tab="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m-2 2l-4.2 4.2m14.2-1.2l-6-6m-6 6l-6-6"></path>
        </svg>
        <span>Settings</span>
      </button>
    </nav>

    <!-- Tab Content: Timer -->
    <div class="tab-content active" id="timer-tab">
      <div class="timer-container">
        <!-- Activity Selector -->
        <div class="activity-selector">
          <select id="activitySelect" class="activity-select">
            <option value="Study">ğŸ“š Study</option>
            <option value="Coding">ğŸ’» Coding</option>
            <option value="Rest">ğŸŒ¸ Rest</option>
          </select>
        </div>

        <!-- Circular Progress Timer -->
        <div class="timer-circle-wrapper">
          <svg class="timer-svg" viewBox="0 0 300 300">
            <defs>
              <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:var(--violet);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--magenta);stop-opacity:1" />
              </linearGradient>
            </defs>
            <!-- Background circle -->
            <circle cx="150" cy="150" r="130" fill="none" stroke="var(--base1)" stroke-width="20" opacity="0.2"/>
            <!-- Progress circle -->
            <circle id="progressCircle" cx="150" cy="150" r="130" fill="none" 
                    stroke="url(#progressGradient)" stroke-width="20" 
                    stroke-linecap="round"
                    stroke-dasharray="817" 
                    stroke-dashoffset="817"
                    transform="rotate(-90 150 150)"/>
          </svg>
          
          <!-- Icon in center -->
          <div class="timer-icon" id="timerIcon">ğŸ“š</div>
          
          <!-- Time display -->
          <div class="timer-display">
            <div class="time-value" id="timeDisplay">25:00</div>
            <div class="time-label" id="sessionLabel">Focus on one task</div>
          </div>
        </div>

        <!-- Control Buttons -->
        <div class="timer-controls">
          <button class="btn-control btn-primary" id="startBtn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <span>Start</span>
          </button>
          <button class="btn-control btn-secondary" id="pauseBtn" style="display:none">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
            <span>Pause</span>
          </button>
          <button class="btn-control btn-ghost" id="resetBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 4v6h6M23 20v-6h-6"/>
              <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
            </svg>
            <span>Reset</span>
          </button>
        </div>

        <!-- Quick Duration Buttons -->
        <div class="quick-durations">
          <button class="duration-btn" data-minutes="15">15m</button>
          <button class="duration-btn active" data-minutes="25">25m</button>
          <button class="duration-btn" data-minutes="45">45m</button>
          <button class="duration-btn" data-minutes="60">60m</button>
        </div>

        <!-- Today's Progress -->
        <div class="today-summary">
          <h3>Today's Progress</h3>
          <div class="summary-stats">
            <div class="stat-card">
              <div class="stat-value" id="todaySessions">0</div>
              <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="todayTime">0h 0m</div>
              <div class="stat-label">Total Time</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="todayStreak">0</div>
              <div class="stat-label">Day Streak</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Analysis -->
    <div class="tab-content" id="analysis-tab">
      <div class="analysis-container">
        <h2 class="section-title">Focus Analysis</h2>
        
        <!-- Time Range Selector -->
        <div class="range-selector">
          <button class="range-btn active" data-range="daily">Daily</button>
          <button class="range-btn" data-range="weekly">Weekly</button>
          <button class="range-btn" data-range="monthly">Monthly</button>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-icon">â±ï¸</div>
            <div class="stat-info">
              <div class="stat-big" id="totalTime">0h 0m</div>
              <div class="stat-desc">Total Focus Time</div>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-info">
              <div class="stat-big" id="totalSessions">0</div>
              <div class="stat-desc">Total Sessions</div>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">âš¡</div>
            <div class="stat-info">
              <div class="stat-big" id="avgSession">0m</div>
              <div class="stat-desc">Avg Session</div>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-info">
              <div class="stat-big" id="currentStreak">0</div>
              <div class="stat-desc">Current Streak</div>
            </div>
          </div>
        </div>

        <!-- Category Breakdown (Pie Chart) -->
        <div class="chart-section">
          <h3>Time by Category</h3>
          <div class="pie-chart-container">
            <svg id="pieChart" viewBox="0 0 200 200"></svg>
            <div class="pie-legend" id="pieLegend"></div>
          </div>
        </div>

        <!-- Recent Sessions -->
        <div class="sessions-section">
          <h3>Recent Sessions</h3>
          <div class="sessions-list" id="sessionsList"></div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Settings -->
    <div class="tab-content" id="settings-tab">
      <div class="settings-container">
        <h2 class="section-title">Settings</h2>

        <!-- Category Management -->
        <div class="settings-section">
          <h3>Activity Categories</h3>
          <p class="section-desc">Customize your focus categories and icons</p>
          
          <div class="categories-list" id="categoriesList"></div>
          
          <button class="btn-add" id="addCategoryBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Add Category</span>
          </button>
        </div>

        <!-- Timer Preferences -->
        <div class="settings-section">
          <h3>Timer Preferences</h3>
          
          <div class="setting-item">
            <label for="autoStartBreak">Auto-start breaks</label>
            <input type="checkbox" id="autoStartBreak" class="toggle-switch">
          </div>
          
          <div class="setting-item">
            <label for="soundEnabled">Sound notifications</label>
            <input type="checkbox" id="soundEnabled" class="toggle-switch" checked>
          </div>
          
          <div class="setting-item">
            <label for="breakDuration">Break duration (minutes)</label>
            <input type="number" id="breakDuration" value="5" min="1" max="30" class="number-input">
          </div>
        </div>

        <!-- Data Management -->
        <div class="settings-section">
          <h3>Data Management</h3>
          
          <div class="data-actions">
            <button class="btn-action" id="exportDataBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>Export Data</span>
            </button>
            
            <label class="btn-action">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Import Data</span>
              <input type="file" id="importDataFile" accept="application/json" hidden>
            </label>
            
            <button class="btn-action btn-danger" id="clearDataBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              <span>Clear All Data</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <dialog id="categoryModal" class="modal">
    <form method="dialog" id="categoryForm" class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Add Category</h3>
        <button type="button" class="modal-close" onclick="categoryModal.close()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <input type="hidden" id="categoryId">
        
        <div class="form-group">
          <label for="categoryName">Category Name</label>
          <input type="text" id="categoryName" required placeholder="e.g., Study, Coding, Exercise">
        </div>
        
        <div class="form-group">
          <label for="categoryIcon">Icon (emoji)</label>
          <input type="text" id="categoryIcon" required placeholder="ğŸ“š" maxlength="2">
          <div class="icon-suggestions">
            <button type="button" class="icon-btn-small" data-icon="ğŸ“š">ğŸ“š</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸ’»">ğŸ’»</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸ¨">ğŸ¨</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸµ">ğŸµ</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸƒ">ğŸƒ</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸŒ¸">ğŸŒ¸</button>
            <button type="button" class="icon-btn-small" data-icon="ğŸ¯">ğŸ¯</button>
            <button type="button" class="icon-btn-small" data-icon="âœï¸">âœï¸</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="categoryColor">Color</label>
          <div class="color-picker">
            <input type="color" id="categoryColor" value="#268bd2">
            <div class="color-suggestions">
              <button type="button" class="color-btn" data-color="#268bd2" style="background:#268bd2"></button>
              <button type="button" class="color-btn" data-color="#2aa198" style="background:#2aa198"></button>
              <button type="button" class="color-btn" data-color="#859900" style="background:#859900"></button>
              <button type="button" class="color-btn" data-color="#b58900" style="background:#b58900"></button>
              <button type="button" class="color-btn" data-color="#cb4b16" style="background:#cb4b16"></button>
              <button type="button" class="color-btn" data-color="#dc322f" style="background:#dc322f"></button>
              <button type="button" class="color-btn" data-color="#d33682" style="background:#d33682"></button>
              <button type="button" class="color-btn" data-color="#6c71c4" style="background:#6c71c4"></button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-ghost" onclick="categoryModal.close()">Cancel</button>
        <button type="button" id="deleteCategoryBtn" class="btn-danger" style="display:none">Delete</button>
        <button type="submit" class="btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

    const SUPABASE_URL = "https://abfuanjincelcyrlswsp.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiZnVhbmppbmNlbGN5cmxzd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjE4MDIsImV4cCI6MjA4MzQzNzgwMn0.OD7371E7A1ZRiqF6SGXnp2JSzPowg2zTt-V36GQ7x9A"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // AUTH CHECK - Must run first
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) {
      window.location.replace("index.html")
      throw new Error("Not authenticated")
    }

// =====================================
// State Management
// =====================================
const state = {
  user: null,
  categories: [],
  sessions: [],
  settings: {
    autoStartBreak: false,
    soundEnabled: true,
    breakDuration: 5
  },
  timer: {
    duration: 25 * 60, // 25 minutes in seconds
    remaining: 25 * 60,
    isRunning: false,
    isPaused: false,
    startTime: null,
    category: 'Study',
    intervalId: null
  },
  currentTab: 'timer',
  analysisRange: 'daily'
}

// Default categories
const DEFAULT_CATEGORIES = [
  { name: 'Study', icon: 'ğŸ“š', color: '#268bd2' },
  { name: 'Coding', icon: 'ğŸ’»', color: '#2aa198' },
  { name: 'Rest', icon: 'ğŸŒ¸', color: '#d33682' }
]

// =====================================
// Utility Functions
// =====================================
const $ = (sel) => document.querySelector(sel)
const $$ = (sel) => Array.from(document.querySelectorAll(sel))

const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36)

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${mins}:${String(secs).padStart(2, '0')}`
}

function formatDuration(minutes) {
  const hours = Math.floor(minutes / 60)
  const mins = minutes % 60
  if (hours > 0) {
    return `${hours}h ${mins}m`
  }
  return `${mins}m`
}

function getTodayString() {
  return new Date().toISOString().split('T')[0]
}

function getDateRange(range) {
  const now = new Date()
  const start = new Date()
  
  if (range === 'daily') {
    start.setHours(0, 0, 0, 0)
  } else if (range === 'weekly') {
    start.setDate(start.getDate() - 7)
  } else if (range === 'monthly') {
    start.setMonth(start.getMonth() - 1)
  }
  
  return { start: start.toISOString(), end: now.toISOString() }
}

// =====================================
// Theme Management
// =====================================
if (localStorage.getItem("pref-theme") === "dark") {
  document.body.classList.add('dark');
} else if (localStorage.getItem("pref-theme") === "light") {
  document.body.classList.remove('dark');
} else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.body.classList.add('dark');
}

const themeToggle = document.getElementById('theme-toggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  if (document.body.classList.contains('dark')) {
    localStorage.setItem('pref-theme', 'dark');
  } else {
    localStorage.setItem('pref-theme', 'light');
  }
});

// =====================================
// Sync Status Management
// =====================================
function updateSyncStatus(status) {
  const syncStatus = $('#syncStatus')
  syncStatus.className = 'sync-status'
  
  if (status === 'synced') {
    syncStatus.classList.add('synced')
    syncStatus.innerHTML = '<span>âœ“</span><span>åŒæœŸæ¸ˆã¿</span>'
  } else if (status === 'syncing') {
    syncStatus.classList.add('syncing')
    syncStatus.innerHTML = '<span class="loading-spinner"></span><span>åŒæœŸä¸­...</span>'
  } else if (status === 'error') {
    syncStatus.classList.add('error')
    syncStatus.innerHTML = '<span>âš </span><span>åŒæœŸã‚¨ãƒ©ãƒ¼</span>'
  }
}

// =====================================
// Initialize App After Auth Check
// =====================================
// We've already checked authentication at the top of the file
// Now initialize the app with the session we know exists
state.user = session.user
$('#userEmail').textContent = session.user.email

// Load data
await loadCategories()
await loadSessions()
await loadSettings()

// Render UI
render()
updateSyncStatus('synced')

// Listen for sign-out events
supabase.auth.onAuthStateChange((event, newSession) => {
  if (event === 'SIGNED_OUT') {
    window.location.replace('index.html')
  }
})

$('#logoutBtn').onclick = async () => {
  if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
    await supabase.auth.signOut()
    // Navigation will be handled by onAuthStateChange
  }
}

// =====================================
// Data Management
// =====================================
async function loadCategories() {
  try {
    updateSyncStatus('syncing')
    const { data, error } = await supabase
      .from('focus_categories')
      .select('*')
      .eq('user_id', state.user.id)
      .order('created_at', { ascending: true })

    if (error) throw error

    if (!data || data.length === 0) {
      // Initialize with default categories
      for (const cat of DEFAULT_CATEGORIES) {
        try {
          await saveCategory({ ...cat, id: uid() })
        } catch (catError) {
          // Ignore duplicate errors - category may already exist
          if (!catError.message?.includes('duplicate key')) {
            console.error('Error creating default category:', catError)
          }
        }
      }
      await loadCategories()
      return
    }

    state.categories = data
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error loading categories:', error)
    updateSyncStatus('error')
  }
}

async function saveCategory(category) {
  try {
    updateSyncStatus('syncing')
    const categoryData = {
      ...category,
      user_id: state.user.id
    }

    // Use upsert with onConflict to handle duplicates
    const { error } = await supabase
      .from('focus_categories')
      .upsert(categoryData, { 
        onConflict: 'id',
        ignoreDuplicates: false 
      })

    if (error) throw error

    await loadCategories()
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error saving category:', error)
    updateSyncStatus('error')
    throw error
  }
}

async function deleteCategory(id) {
  try {
    updateSyncStatus('syncing')
    const { error } = await supabase
      .from('focus_categories')
      .delete()
      .eq('id', id)
      .eq('user_id', state.user.id)

    if (error) throw error

    await loadCategories()
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error deleting category:', error)
    updateSyncStatus('error')
    throw error
  }
}

async function loadSessions() {
  try {
    updateSyncStatus('syncing')
    const { data, error } = await supabase
      .from('focus_sessions')
      .select('*')
      .eq('user_id', state.user.id)
      .order('start_time', { ascending: false })

    if (error) throw error

    state.sessions = data || []
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error loading sessions:', error)
    updateSyncStatus('error')
  }
}

async function saveSession(session) {
  try {
    updateSyncStatus('syncing')
    const sessionData = {
      ...session,
      user_id: state.user.id
    }

    const { error } = await supabase
      .from('focus_sessions')
      .insert(sessionData)

    if (error) throw error

    await loadSessions()
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error saving session:', error)
    updateSyncStatus('error')
    throw error
  }
}

async function loadSettings() {
  try {
    const { data, error } = await supabase
      .from('focus_settings')
      .select('*')
      .eq('user_id', state.user.id)
      .single()

    if (error && error.code !== 'PGRST116') throw error

    if (data) {
      state.settings = data.settings
    }
  } catch (error) {
    console.error('Error loading settings:', error)
  }
}

async function saveSettings() {
  try {
    const { error } = await supabase
      .from('focus_settings')
      .upsert({
        user_id: state.user.id,
        settings: state.settings
      })

    if (error) throw error
  } catch (error) {
    console.error('Error saving settings:', error)
    throw error
  }
}

async function clearAllData() {
  try {
    updateSyncStatus('syncing')
    
    await supabase.from('focus_sessions').delete().eq('user_id', state.user.id)
    await supabase.from('focus_categories').delete().eq('user_id', state.user.id)
    await supabase.from('focus_settings').delete().eq('user_id', state.user.id)

    await loadCategories()
    await loadSessions()
    await loadSettings()
    
    updateSyncStatus('synced')
  } catch (error) {
    console.error('Error clearing data:', error)
    updateSyncStatus('error')
    throw error
  }
}

// =====================================
// Tab Navigation
// =====================================
$$('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    const tab = btn.dataset.tab
    state.currentTab = tab
    
    $$('.tab-btn').forEach(b => b.classList.remove('active'))
    $$('.tab-content').forEach(c => c.classList.remove('active'))
    
    btn.classList.add('active')
    $(`#${tab}-tab`).classList.add('active')
    
    if (tab === 'analysis') {
      renderAnalysis()
    } else if (tab === 'settings') {
      renderSettings()
    }
  }
})

// =====================================
// Timer Functions
// =====================================
function startTimer() {
  if (state.timer.isRunning) return
  
  state.timer.isRunning = true
  state.timer.isPaused = false
  state.timer.startTime = Date.now()
  
  $('#startBtn').style.display = 'none'
  $('#pauseBtn').style.display = 'flex'
  
  state.timer.intervalId = setInterval(updateTimer, 1000)
  updateTimerDisplay()
}

function pauseTimer() {
  if (!state.timer.isRunning) return
  
  state.timer.isRunning = false
  state.timer.isPaused = true
  
  $('#startBtn').style.display = 'flex'
  $('#pauseBtn').style.display = 'none'
  
  clearInterval(state.timer.intervalId)
}

function resetTimer() {
  pauseTimer()
  
  state.timer.remaining = state.timer.duration
  state.timer.isPaused = false
  state.timer.startTime = null
  
  updateTimerDisplay()
}

function updateTimer() {
  if (!state.timer.isRunning) return
  
  state.timer.remaining--
  
  if (state.timer.remaining <= 0) {
    completeSession()
  }
  
  updateTimerDisplay()
}

function updateTimerDisplay() {
  const { remaining, duration } = state.timer
  
  // Update time text
  $('#timeDisplay').textContent = formatTime(remaining)
  
  // Update circular progress
  const progress = (duration - remaining) / duration
  const circumference = 2 * Math.PI * 130 // radius = 130
  const offset = circumference - (progress * circumference)
  $('#progressCircle').style.strokeDashoffset = offset
}

async function completeSession() {
  pauseTimer()
  
  if (state.settings.soundEnabled) {
    playCompletionSound()
  }
  
  // Save session
  const sessionMinutes = Math.floor(state.timer.duration / 60)
  const session = {
    id: uid(),
    category: state.timer.category,
    duration_minutes: sessionMinutes,
    start_time: new Date(state.timer.startTime).toISOString(),
    end_time: new Date().toISOString(),
    date: getTodayString()
  }
  
  await saveSession(session)
  
  // Reset timer
  resetTimer()
  
  // Update displays
  renderTodaySummary()
  
  alert(`ğŸ‰ Well done! You completed a ${sessionMinutes}-minute ${state.timer.category} session!`)
}

function playCompletionSound() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)()
  const oscillator = audioContext.createOscillator()
  const gainNode = audioContext.createGain()
  
  oscillator.connect(gainNode)
  gainNode.connect(audioContext.destination)
  
  oscillator.frequency.value = 800
  oscillator.type = 'sine'
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime)
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5)
  
  oscillator.start(audioContext.currentTime)
  oscillator.stop(audioContext.currentTime + 0.5)
}

// Timer Controls
$('#startBtn').onclick = startTimer
$('#pauseBtn').onclick = pauseTimer
$('#resetBtn').onclick = resetTimer

// Quick Duration Buttons
$$('.duration-btn').forEach(btn => {
  btn.onclick = () => {
    const minutes = parseInt(btn.dataset.minutes)
    
    if (state.timer.isRunning) {
      if (!confirm('Timer is running. Reset it?')) return
      pauseTimer()
    }
    
    state.timer.duration = minutes * 60
    state.timer.remaining = minutes * 60
    
    $$('.duration-btn').forEach(b => b.classList.remove('active'))
    btn.classList.add('active')
    
    updateTimerDisplay()
  }
})

// Activity Selector
$('#activitySelect').onchange = (e) => {
  state.timer.category = e.target.value
  
  const category = state.categories.find(c => c.name === e.target.value)
  if (category) {
    $('#timerIcon').textContent = category.icon
  }
}

// =====================================
// Rendering Functions
// =====================================
function render() {
  renderActivitySelect()
  renderTodaySummary()
  renderCategoriesList()
}

function renderActivitySelect() {
  const select = $('#activitySelect')
  select.innerHTML = state.categories.map(cat => 
    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
  ).join('')
  
  // Set icon
  const firstCat = state.categories[0]
  if (firstCat) {
    $('#timerIcon').textContent = firstCat.icon
    state.timer.category = firstCat.name
  }
}

function renderTodaySummary() {
  const today = getTodayString()
  const todaySessions = state.sessions.filter(s => s.date === today)
  
  const totalMinutes = todaySessions.reduce((sum, s) => sum + s.duration_minutes, 0)
  const hours = Math.floor(totalMinutes / 60)
  const mins = totalMinutes % 60
  
  $('#todaySessions').textContent = todaySessions.length
  $('#todayTime').textContent = `${hours}h ${mins}m`
  
  // Calculate streak
  const streak = calculateStreak()
  $('#todayStreak').textContent = streak
}

function calculateStreak() {
  const dates = [...new Set(state.sessions.map(s => s.date))].sort().reverse()
  
  let streak = 0
  const today = getTodayString()
  let currentDate = new Date()
  
  for (let i = 0; i < dates.length; i++) {
    const dateStr = currentDate.toISOString().split('T')[0]
    
    if (dates.includes(dateStr)) {
      streak++
      currentDate.setDate(currentDate.getDate() - 1)
    } else {
      break
    }
  }
  
  return streak
}

// =====================================
// Analysis Tab
// =====================================
$$('.range-btn').forEach(btn => {
  btn.onclick = () => {
    state.analysisRange = btn.dataset.range
    $$('.range-btn').forEach(b => b.classList.remove('active'))
    btn.classList.add('active')
    renderAnalysis()
  }
})

function renderAnalysis() {
  const { start, end } = getDateRange(state.analysisRange)
  const sessions = state.sessions.filter(s => {
    const sessionDate = new Date(s.start_time)
    return sessionDate >= new Date(start) && sessionDate <= new Date(end)
  })
  
  // Stats
  const totalMinutes = sessions.reduce((sum, s) => sum + s.duration_minutes, 0)
  const avgMinutes = sessions.length > 0 ? Math.floor(totalMinutes / sessions.length) : 0
  
  $('#totalTime').textContent = formatDuration(totalMinutes)
  $('#totalSessions').textContent = sessions.length
  $('#avgSession').textContent = `${avgMinutes}m`
  $('#currentStreak').textContent = calculateStreak()
  
  // Pie chart
  renderPieChart(sessions)
  
  // Recent sessions
  renderRecentSessions(sessions)
}

function renderPieChart(sessions) {
  const categoryTotals = {}
  
  sessions.forEach(s => {
    categoryTotals[s.category] = (categoryTotals[s.category] || 0) + s.duration_minutes
  })
  
  const total = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0)
  
  if (total === 0) {
    $('#pieChart').innerHTML = '<text x="100" y="100" text-anchor="middle" fill="var(--secondary)" font-size="14">No data</text>'
    $('#pieLegend').innerHTML = ''
    return
  }
  
  const svg = $('#pieChart')
  svg.innerHTML = ''
  
  let startAngle = 0
  const legend = $('#pieLegend')
  legend.innerHTML = ''
  
  Object.entries(categoryTotals).forEach(([name, minutes]) => {
    const category = state.categories.find(c => c.name === name)
    const color = category?.color || '#268bd2'
    const percentage = (minutes / total) * 100
    const angle = (minutes / total) * 360
    
    // Create pie slice
    const slice = createPieSlice(100, 100, 80, startAngle, startAngle + angle, color)
    svg.appendChild(slice)
    
    // Create legend item
    const legendItem = document.createElement('div')
    legendItem.className = 'legend-item'
    legendItem.innerHTML = `
      <div class="legend-color" style="background: ${color}"></div>
      <div class="legend-label">${category?.icon || ''} ${name}</div>
      <div class="legend-value">${percentage.toFixed(1)}%</div>
    `
    legend.appendChild(legendItem)
    
    startAngle += angle
  })
}

function createPieSlice(cx, cy, r, startAngle, endAngle, color) {
  const start = polarToCartesian(cx, cy, r, endAngle)
  const end = polarToCartesian(cx, cy, r, startAngle)
  const largeArc = endAngle - startAngle <= 180 ? '0' : '1'
  
  const d = [
    'M', cx, cy,
    'L', start.x, start.y,
    'A', r, r, 0, largeArc, 0, end.x, end.y,
    'Z'
  ].join(' ')
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path')
  path.setAttribute('d', d)
  path.setAttribute('fill', color)
  path.setAttribute('stroke', 'var(--theme)')
  path.setAttribute('stroke-width', '2')
  
  return path
}

function polarToCartesian(cx, cy, r, angle) {
  const rad = (angle - 90) * Math.PI / 180
  return {
    x: cx + r * Math.cos(rad),
    y: cy + r * Math.sin(rad)
  }
}

function renderRecentSessions(sessions) {
  const list = $('#sessionsList')
  
  if (sessions.length === 0) {
    list.innerHTML = '<div class="empty-state">No sessions yet</div>'
    return
  }
  
  list.innerHTML = sessions.slice(0, 10).map(s => {
    const category = state.categories.find(c => c.name === s.category)
    const date = new Date(s.start_time).toLocaleDateString('ja-JP', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
    
    return `
      <div class="session-item">
        <div class="session-icon">${category?.icon || 'ğŸ“Œ'}</div>
        <div class="session-info">
          <div class="session-title">${s.category}</div>
          <div class="session-meta">${date}</div>
        </div>
        <div class="session-duration">${s.duration_minutes}m</div>
      </div>
    `
  }).join('')
}

// =====================================
// Settings Tab
// =====================================
function renderSettings() {
  renderCategoriesList()
  
  // Load settings
  $('#autoStartBreak').checked = state.settings.autoStartBreak
  $('#soundEnabled').checked = state.settings.soundEnabled
  $('#breakDuration').value = state.settings.breakDuration
}

function renderCategoriesList() {
  const list = $('#categoriesList')
  
  list.innerHTML = state.categories.map(cat => `
    <div class="category-item" data-id="${cat.id}">
      <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color}">
        ${cat.icon}
      </div>
      <div class="category-name">${cat.name}</div>
    </div>
  `).join('')
  
  // Add click handlers
  $$('.category-item').forEach(item => {
    item.onclick = () => {
      const id = item.dataset.id
      const category = state.categories.find(c => c.id === id)
      openCategoryModal(category)
    }
  })
}

// Category Modal
const categoryModal = $('#categoryModal')

function openCategoryModal(category = null) {
  $('#modalTitle').textContent = category ? 'Edit Category' : 'Add Category'
  $('#categoryId').value = category?.id || ''
  $('#categoryName').value = category?.name || ''
  $('#categoryIcon').value = category?.icon || ''
  $('#categoryColor').value = category?.color || '#268bd2'
  
  $('#deleteCategoryBtn').style.display = category ? 'block' : 'none'
  
  categoryModal.showModal()
}

$('#addCategoryBtn').onclick = () => openCategoryModal()

$('#categoryForm').onsubmit = async (e) => {
  e.preventDefault()
  
  const id = $('#categoryId').value || uid()
  const name = $('#categoryName').value.trim()
  
  // Check if category name already exists (excluding current category being edited)
  const existingCategory = state.categories.find(c => 
    c.name.toLowerCase() === name.toLowerCase() && c.id !== id
  )
  
  if (existingCategory) {
    alert(`ã‚«ãƒ†ã‚´ãƒªãƒ¼ "${name}" ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`)
    return
  }
  
  const category = {
    id,
    name,
    icon: $('#categoryIcon').value.trim(),
    color: $('#categoryColor').value
  }
  
  try {
    await saveCategory(category)
    categoryModal.close()
    render()
  } catch (error) {
    console.error('Save error:', error)
    if (error.message?.includes('duplicate key')) {
      alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼åã¯ã™ã§ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚')
    } else {
      alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
    }
  }
}

$('#deleteCategoryBtn').onclick = async () => {
  const id = $('#categoryId').value
  if (!id) return
  
  if (confirm('Delete this category? Sessions will not be deleted.')) {
    try {
      await deleteCategory(id)
      categoryModal.close()
      render()
    } catch (error) {
      alert('Failed to delete category: ' + error.message)
    }
  }
}

// Icon and color suggestions
$$('.icon-btn-small').forEach(btn => {
  btn.onclick = () => {
    $('#categoryIcon').value = btn.dataset.icon
  }
})

$$('.color-btn').forEach(btn => {
  btn.onclick = () => {
    $('#categoryColor').value = btn.dataset.color
  }
})

// Settings changes
$('#autoStartBreak').onchange = async (e) => {
  state.settings.autoStartBreak = e.target.checked
  await saveSettings()
}

$('#soundEnabled').onchange = async (e) => {
  state.settings.soundEnabled = e.target.checked
  await saveSettings()
}

$('#breakDuration').onchange = async (e) => {
  state.settings.breakDuration = parseInt(e.target.value)
  await saveSettings()
}

// Data Management
$('#exportDataBtn').onclick = () => {
  const data = {
    categories: state.categories,
    sessions: state.sessions,
    settings: state.settings
  }
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
  const a = document.createElement('a')
  a.href = URL.createObjectURL(blob)
  a.download = `focus-timer-${getTodayString()}.json`
  a.click()
  URL.revokeObjectURL(a.href)
}

$('#importDataFile').onchange = async (e) => {
  const file = e.target.files[0]
  if (!file) return
  
  try {
    const text = await file.text()
    const data = JSON.parse(text)
    
    if (!confirm('This will overwrite existing data. Continue?')) {
      e.target.value = ''
      return
    }
    
    // Import categories
    if (data.categories) {
      for (const cat of data.categories) {
        await saveCategory(cat)
      }
    }
    
    // Import sessions
    if (data.sessions) {
      for (const session of data.sessions) {
        await saveSession(session)
      }
    }
    
    // Import settings
    if (data.settings) {
      state.settings = data.settings
      await saveSettings()
    }
    
    alert('Data imported successfully!')
    render()
  } catch (error) {
    alert('Import failed: ' + error.message)
  }
  
  e.target.value = ''
}

$('#clearDataBtn').onclick = async () => {
  if (!confirm('Delete ALL data? This cannot be undone!')) return
  if (!confirm('Are you absolutely sure? All sessions and categories will be deleted.')) return
  
  try {
    await clearAllData()
    alert('All data cleared.')
    render()
  } catch (error) {
    alert('Failed to clear data: ' + error.message)
  }
}
  </script>
</body>
</html>