<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar Printing screen — 451-Solarized</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic UI", "Meiryo", sans-serif;
      background: #ffffff;
      padding: 20px;
      color: #333;
    }
    
    .print-container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 400;
      color: #555;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }
    
    .header .date {
      font-size: 18px;
      color: #888;
      font-weight: 300;
    }
    
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .dow {
      background: #f8f8f8;
      padding: 12px;
      text-align: center;
      font-weight: 500;
      font-size: 14px;
      color: #666;
      border-right: 1px solid #e8e8e8;
      border-bottom: 1px solid #e8e8e8;
    }
    
    .dow:nth-child(7) {
      border-right: none;
    }
    
    .cell {
      min-height: 120px;
      padding: 8px;
      border-right: 1px solid #e8e8e8;
      border-bottom: 1px solid #e8e8e8;
      background: white;
      position: relative;
    }
    
    .cell:nth-child(7n) {
      border-right: none;
    }
    
    .cell.empty {
      background: #fafafa;
    }
    
    .date {
      font-size: 16px;
      color: #888;
      font-weight: 300;
      margin-bottom: 6px;
    }
    
    .cell.today .date {
      color: #4a90e2;
      font-weight: 500;
    }
    
    .event {
      font-size: 11px;
      padding: 4px 6px;
      margin-bottom: 3px;
      border-radius: 3px;
      background: #f0f0f0;
      color: #555;
      line-height: 1.4;
      border-left: 3px solid #bbb;
      word-wrap: break-word;
    }
    
    .event.type-課題提出日 {
      border-left-color: #4a90e2;
      background: #e8f2ff;
    }
    
    .event.type-試験 {
      border-left-color: #e63946;
      background: #ffe8e8;
    }
    
    .event.type-定期試験 {
      border-left-color: #f7a500;
      background: #fff3e0;
    }
    
    .event.type-東進模試 {
      border-left-color: #009c88;
      background: #e0f5f2;
    }
    
    .event.type-部活動 {
      border-left-color: #00c3ff;
      background: #e0f7ff;
    }
    
    .event.type-長期休み {
      border-left-color: #ff6b9d;
      background: #ffe8f0;
    }
    
    .event-time {
      font-weight: 500;
      color: #333;
      margin-right: 4px;
    }
    
    .footer {
      margin-top: 20px;
      text-align: center;
      color: #999;
      font-size: 12px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
    .controls {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
    }
    
    .controls button {
      padding: 12px 24px;
      margin: 0 8px;
      border: 1px solid #ddd;
      background: white;
      color: #555;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    .controls button:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .controls button.primary {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    
    .controls button.primary:hover {
      background: #357abd;
      border-color: #357abd;
    }
    
    @media print {
      .controls {
        display: none;
      }
      
      body {
        padding: 10px;
      }
      
      .calendar {
        border: 1px solid #999;
      }
      
      .dow, .cell {
        border-color: #ccc;
      }
    }
  </style>
</head>
<body>
  <div class="print-container">
    <div class="controls">
      <button onclick="window.print()">Print</button>
      <button onclick="window.close()" class="primary">✕ Close</button>
    </div>
    
    <div class="header">
      <h1 id="calendarTitle">Calendar</h1>
      <div class="date" id="calendarDate"></div>
    </div>
    
    <div id="calendar" class="calendar"></div>
    
    <div class="footer">
      Generated by 451-Solarized Calendar App
    </div>
  </div>
  
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const SUPABASE_URL = 'https://abfuanjincelcyrlswsp.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiZnVhbmppbmNlbGN5cmxzd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjE4MDIsImV4cCI6MjA4MzQzNzgwMn0.OD7371E7A1ZRiqF6SGXnp2JSzPowg2zTt-V36GQ7x9A'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    // URLパラメータから年月とフィルターを取得
    const params = new URLSearchParams(window.location.search)
    const year = parseInt(params.get('year') || new Date().getFullYear())
    const month = parseInt(params.get('month') || new Date().getMonth())
    const filterCourse = params.get('course') || ''
    const filterType = params.get('type') || ''
    
    const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
    
    document.getElementById('calendarTitle').textContent = `${year}年 ${monthNames[month]}`
    document.getElementById('calendarDate').textContent = new Date().toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }) + ' 印刷'
    
    function formatDate(d) {
      const dt = d instanceof Date ? d : new Date(d)
      return dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0')
    }
    
    function getMonthMatrix(y, m) {
      const days = []
      const firstDay = new Date(y, m, 1)
      let dayOfWeek = firstDay.getDay()
      dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1
      
      for (let i = 0; i < dayOfWeek; i++) {
        days.push(null)
      }
      
      const last = new Date(y, m + 1, 0).getDate()
      for (let d = 1; d <= last; d++) {
        days.push(new Date(y, m, d))
      }
      return days
    }
    
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]))
    }
    
    async function render() {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        alert('ログインが必要です')
        window.close()
        return
      }
      
      const { data: events, error } = await supabase
        .from('calendar_app')
        .select('*')
        .eq('user_id', session.user.id)
        .order('date', { ascending: true })
      
      if (error) {
        console.error('Error loading events:', error)
        return
      }
      
      const filtered = events.filter(e =>
        (!filterCourse || e.course === filterCourse) &&
        (!filterType || e.type === filterType)
      )
      
      const cal = document.getElementById('calendar')
      cal.innerHTML = ''
      
      const dows = ['月', '火', '水', '木', '金', '土', '日']
      dows.forEach(d => {
        const h = document.createElement('div')
        h.className = 'dow'
        h.textContent = d
        cal.appendChild(h)
      })
      
      const cells = getMonthMatrix(year, month)
      const todayStr = formatDate(new Date())
      
      cells.forEach(d => {
        const cell = document.createElement('div')
        cell.className = 'cell'
        
        if (d === null) {
          cell.classList.add('empty')
          cal.appendChild(cell)
          return
        }
        
        const dStr = formatDate(d)
        const inMonth = d.getMonth() === month
        
        if (dStr === todayStr) {
          cell.classList.add('today')
        }
        
        if (!inMonth) {
          cell.style.opacity = '0.4'
        }
        
        const dateEl = document.createElement('div')
        dateEl.className = 'date'
        dateEl.textContent = d.getDate()
        cell.appendChild(dateEl)
        
        filtered
          .filter(e => e.date === dStr && inMonth)
          .sort((a, b) => {
            if (a.start && b.start) return a.start.localeCompare(b.start)
            if (a.start) return -1
            if (b.start) return 1
            return a.title.localeCompare(b.title)
          })
          .forEach(e => {
            const eventEl = document.createElement('div')
            const typeClass = e.type.replace(/\s+/g, '-').replace(/\//g, '')
            eventEl.className = `event type-${typeClass}`
            
            let content = ''
            if (e.start) {
              content += `<span class="event-time">${e.start}</span>`
            }
            content += escapeHtml(e.title || '無題')
            
            eventEl.innerHTML = content
            cell.appendChild(eventEl)
          })
        
        cal.appendChild(cell)
      })
    }
    
    render()
  </script>
</body>
</html>